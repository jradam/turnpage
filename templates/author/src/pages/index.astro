---
import { SUPABASE_URL, SUPABASE_ANON_KEY, PROFILE_ID } from 'astro:env/server'
import { createSupabase, type Book, type Profile } from '@turnpage/shared'
import Article from '../components/Article.astro'
import Books from '../components/Books.astro'
import Header from '../components/Header.astro'
import Hero from '../components/Hero.astro'
import Layout from '../layouts/Layout.astro'

const supabase = createSupabase({ SUPABASE_URL, SUPABASE_ANON_KEY })

const getProfile = async (): Promise<Profile> => {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', PROFILE_ID)
    .single()
    // Supabase has generic 'Json' types, override with our own type
    .overrideTypes<Profile, { merge: false }>() 

  if (!data || error) throw Error(error.message || 'No profile found')
  return data
}

type AtLeastOneBook = [Book, ...Book[]]
const getBooks = async (): Promise<AtLeastOneBook> => {
  const { data, error } = await supabase
    .from('works')
    .select('*')
    .eq('profile_id', PROFILE_ID)
    .eq('work_type', 'book')
    // Supabase has generic 'Json' types, override with our own type
    .overrideTypes<Book[], { merge: false }>()

  if (!data || error) throw Error(error.message || 'No books found')

  const books = data.sort((a, b) => a.order - b.order)

  const [first, ...rest] = books
  if (!first) throw Error('No books')

  return [first, ...rest]
}

const profile = await getProfile()
const books = await getBooks()

if (!profile.name || !profile.bio) throw Error('Missing key profile info')
---

<Layout profile={profile}>
  <Header>{profile.name}</Header>
  <Hero book={books[0]} />
  <Article
    title={profile.name}
    paragraphs={profile.bio}
    image={profile.photo_url}
  />
  <Books books={books} defaultAuthor={profile.name} />
</Layout>
